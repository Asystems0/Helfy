
networks:
  helfy-net:
    driver: bridge

services:
  # PD (Placement Driver): The brain of the TiDB cluster.
  # purpose: Stores the metadata of the cluster (regions, locations) and handles load balancing and scheduling of data.
  # image: pingcap/pd
  pd0:
    image: pingcap/pd:latest
    container_name: pd0
    ports:
      - "12379:2379"
    command:
      - --name=pd0
      - --client-urls=http://0.0.0.0:2379
      - --peer-urls=http://0.0.0.0:2380
      - --advertise-client-urls=http://pd0:2379
      - --advertise-peer-urls=http://pd0:2380
      - --initial-cluster=pd0=http://pd0:2380
      - --data-dir=/data/default.pd
    restart: always
    networks:
      - helfy-net

  # TiKV (Ti Key-Value): The storage engine.
  # purpose: Distributed transactional key-value storage. Stores the actual data using Raft for consistency.
  # image: pingcap/tikv
  tikv0:
    image: pingcap/tikv:latest
    container_name: tikv0
    ports:
      - "20160:20160"
    command:
      - --addr=0.0.0.0:20160
      - --advertise-addr=tikv0:20160
      - --data-dir=/data/default.tikv
      - --pd=pd0:2379
    depends_on:
      - pd0
    restart: always
    networks:
      - helfy-net

  # TiDB: The SQL layer.
  # purpose: Speaks MySQL protocol, parses SQL, and maps it to key-value requests for TiKV. Stateless.
  # image: pingcap/tidb
  tidb0:
    image: pingcap/tidb:latest
    container_name: tidb0
    ports:
      - "4000:4000"
      - "10080:10080"
    command:
      - --store=tikv
      - --path=pd0:2379
    depends_on:
      - pd0
      - tikv0
    restart: always
    networks:
      - helfy-net

  # TiDB Initialization Service
  # purpose: Waits for TiDB to be ready and runs the initialization SQL script to create DB and User.
  # image: mysql:5.7 (using the mysql client)
  tidb-init:
    image: mysql:5.7
    container_name: tidb-init
    volumes:
      - ./config/init.sql:/config/init.sql
    entrypoint: ["bash", "-c", "echo 'Waiting for TiDB...' && until mysql -h tidb0 -P 4000 -u root -e 'SELECT 1'; do sleep 2; done && echo 'TiDB is ready! Running init script...' && mysql -h tidb0 -P 4000 -u root < /config/init.sql && echo 'Initialization complete.'"]
    depends_on:
      - tidb0
    networks:
      - helfy-net

  # Zookeeper: Coordinator for Kafka
  zookeeper:
    image: wurstmeister/zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181"
    restart: always
    networks:
      - helfy-net

  # Kafka: Message Broker
  kafka:
    image: wurstmeister/kafka
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: kafka
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CREATE_TOPICS: "helfy-cdc-topic:1:1"
    depends_on:
      - zookeeper
    restart: always
    networks:
      - helfy-net

  # TiCDC: Change Data Capture for TiDB
  ticdc:
    image: pingcap/ticdc:latest
    container_name: ticdc
    ports:
      - "8300:8300"
    command:
      - /cdc
      - server
      - --pd=http://pd0:2379
      - --addr=0.0.0.0:8300
      - --advertise-addr=ticdc:8300
      - --data-dir=/data/ticdc
    depends_on:
      - pd0
      - tikv0
      - tidb0
      - kafka
    restart: always
    networks:
      - helfy-net

  # TiCDC Init: Creates the replication task
  ticdc-init:
    image: pingcap/ticdc:latest
    container_name: ticdc-init
    volumes:
      - ./config/create_changefeed.sh:/create_changefeed.sh
    entrypoint: ["/bin/sh", "/create_changefeed.sh"]
    depends_on:
      - ticdc
      - kafka
    networks:
      - helfy-net

  # Node.js Consumer: Processes CDC events
  consumer:
    build: ./consumer
    container_name: consumer
    ports:
      - "3000:3000"
    depends_on:
      - kafka
    restart: always
    networks:
      - helfy-net

  # Elasticsearch: Log Storage
  elasticsearch:
    image: elasticsearch:7.17.7
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    restart: always
    networks:
      - helfy-net

  # Filebeat: Log Shipper
  filebeat:
    image: docker.elastic.co/beats/filebeat:7.17.7
    container_name: filebeat
    user: root
    volumes:
      - ./monitoring/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: filebeat -e -strict.perms=false
    depends_on:
      - elasticsearch
    restart: always
    networks:
      - helfy-net

  # Prometheus: Metrics Collection
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    restart: always
    networks:
      - helfy-net

  # Grafana: Visualization
  grafana:
    image: grafana/grafana
    container_name: grafana
    ports:
      - "3001:3000"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ./monitoring/grafana/dashboards:/etc/grafana/dashboards
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
      - elasticsearch
    restart: always
    networks:
      - helfy-net
